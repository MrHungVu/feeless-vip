var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { Adapter, WalletConnectionError, WalletDisconnectionError, AdapterState, WalletWindowClosedError, WalletNotFoundError, WalletDisconnectedError, WalletSignMessageError, WalletSignTransactionError, WalletReadyState, } from '@tronweb3/tronwallet-abstract-adapter';
import { ChainNetwork } from '@tronweb3/tronwallet-abstract-adapter';
import { WalletConnectWallet, WalletConnectChainID } from '@tronweb3/walletconnect-tron';
export const WalletConnectWalletName = 'WalletConnect';
const NETWORK = Object.keys(ChainNetwork);
const validThemeVariables = [
    '--w3m-font-family',
    '--w3m-accent',
    '--w3m-color-mix',
    '--w3m-color-mix-strength',
    '--w3m-font-size-master',
    '--w3m-border-radius-master',
    '--w3m-z-index',
    '--w3m-qr-color',
];
export class WalletConnectAdapter extends Adapter {
    constructor(config) {
        var _a, _b, _c, _d, _e;
        super();
        this.name = WalletConnectWalletName;
        this.url = 'https://walletconnect.org';
        this.icon = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJtNjEuNDM4NTQsOTQuMDAzOGM0OC45MTEyMywtNDcuODg4MTcgMTI4LjIxMTk5LC00Ny44ODgxNyAxNzcuMTIzMjEsMGw1Ljg4NjU1LDUuNzYzNDJjMi40NDU1NiwyLjM5NDQxIDIuNDQ1NTYsNi4yNzY1MSAwLDguNjcwOTJsLTIwLjEzNjcsMTkuNzE1NWMtMS4yMjI3OCwxLjE5NzIxIC0zLjIwNTMsMS4xOTcyMSAtNC40MjgwOCwwbC04LjEwMDU4LC03LjkzMTE1Yy0zNC4xMjE2OSwtMzMuNDA3OTggLTg5LjQ0Mzg5LC0zMy40MDc5OCAtMTIzLjU2NTU4LDBsLTguNjc1MDYsOC40OTM2MWMtMS4yMjI3OCwxLjE5NzIgLTMuMjA1MywxLjE5NzIgLTQuNDI4MDgsMGwtMjAuMTM2NjksLTE5LjcxNTVjLTIuNDQ1NTYsLTIuMzk0NDEgLTIuNDQ1NTYsLTYuMjc2NTIgMCwtOC42NzA5Mmw2LjQ2MTAxLC02LjMyNTg4em0yMTguNzY3OCw0MC43NzM3NWwxNy45MjE3LDE3LjU0Njg5YzIuNDQ1NTQsMi4zOTQ0IDIuNDQ1NTYsNi4yNzY0OCAwLjAwMDAzLDguNjcwODlsLTgwLjgxMDE3LDc5LjEyMTE0Yy0yLjQ0NTU1LDIuMzk0NDIgLTYuNDEwNTksMi4zOTQ0NSAtOC44NTYxNiwwLjAwMDA2Yy0wLjAwMDAxLC0wLjAwMDAxIC0wLjAwMDAzLC0wLjAwMDAyIC0wLjAwMDA0LC0wLjAwMDAzbC01Ny4zNTQxNCwtNTYuMTU0NThjLTAuNjExMzksLTAuNTk4NiAtMS42MDI2NSwtMC41OTg2IC0yLjIxNDA0LDBjMCwwLjAwMDAxIC0wLjAwMDAxLDAuMDAwMDEgLTAuMDAwMDEsMC4wMDAwMmwtNTcuMzUyOTIsNTYuMTU0NTNjLTIuNDQ1NTQsMi4zOTQ0MyAtNi40MTA1OCwyLjM5NDQ3IC04Ljg1NjE2LDAuMDAwMDhjLTAuMDAwMDIsLTAuMDAwMDEgLTAuMDAwMDMsLTAuMDAwMDIgLTAuMDAwMDUsLTAuMDAwMDRsLTgwLjgxMjQyLC03OS4xMjIxOWMtMi40NDU1NiwtMi4zOTQ0IC0yLjQ0NTU2LC02LjI3NjUxIDAsLTguNjcwOTFsMTcuOTIxNzMsLTE3LjU0Njg3YzIuNDQ1NTYsLTIuMzk0NDEgNi40MTA2LC0yLjM5NDQxIDguODU2MTYsMGw1Ny4zNTQ5OCw1Ni4xNTUzNWMwLjYxMTM5LDAuNTk4NjEgMS42MDI2NSwwLjU5ODYxIDIuMjE0MDQsMGMwLjAwMDAxLDAgMC4wMDAwMiwtMC4wMDAwMSAwLjAwMDAzLC0wLjAwMDAybDU3LjM1MjEsLTU2LjE1NTMzYzIuNDQ1NSwtMi4zOTQ0NyA2LjQxMDU0LC0yLjM5NDU2IDguODU2MTYsLTAuMDAwMmMwLjAwMDAzLDAuMDAwMDMgMC4wMDAwNywwLjAwMDA3IDAuMDAwMSwwLjAwMDFsNTcuMzU0OSw1Ni4xNTU0M2MwLjYxMTM5LDAuNTk4NiAxLjYwMjY1LDAuNTk4NiAyLjIxNDA0LDBsNTcuMzUzOTgsLTU2LjE1NDMyYzIuNDQ1NTYsLTIuMzk0NDEgNi40MTA2LC0yLjM5NDQxIDguODU2MTYsMHoiIGZpbGw9IiMzYjk5ZmMiIGlkPSJzdmdfMSIvPjwvc3ZnPg==';
        this._readyState = WalletReadyState.Found;
        this._state = AdapterState.Disconnect;
        this._disconnected = () => {
            const wallet = this._wallet;
            if (wallet) {
                wallet.off('disconnected', this._disconnected);
                wallet.off('accountsChanged', this._accountsChanged);
                this._address = null;
                this._state = AdapterState.Disconnect;
                this.emit('disconnect');
                this.emit('stateChanged', this._state);
            }
        };
        this._accountsChanged = (curAddr) => {
            const preAddress = this.address;
            this._address = (curAddr === null || curAddr === void 0 ? void 0 : curAddr[0]) || '';
            this.emit('accountsChanged', this.address || '', preAddress || '');
        };
        config = Object.assign({}, config);
        if (!config || typeof config !== 'object') {
            throw new Error(`[WalletconnectAdapter] config is required.`);
        }
        if (!config.network) {
            console.error(`[WalletconnectAdapter] config.network must be one of ${NETWORK.join()} or a chainID such as 0x2b6653dc. Use Nile network instead.`);
            config.network = 'Nile';
        }
        if (!config.options) {
            throw new Error(`[WalletconnectAdapter] config.options is required.`);
        }
        const themeVariables = {};
        if ((_a = config.web3ModalConfig) === null || _a === void 0 ? void 0 : _a.themeVariables) {
            Object.entries(config.web3ModalConfig.themeVariables).forEach(([k, v]) => {
                const w3mKey = k.replace('--wcm-', '--w3m-');
                if (validThemeVariables.includes(w3mKey)) {
                    // @ts-ignore
                    themeVariables[w3mKey] = v;
                }
            });
        }
        config.themeMode = config.themeMode || ((_b = config.web3ModalConfig) === null || _b === void 0 ? void 0 : _b.themeMode);
        config.themeVariables = config.themeVariables || themeVariables;
        config.featuredWalletIds =
            config.featuredWalletIds ||
                (((_c = config.web3ModalConfig) === null || _c === void 0 ? void 0 : _c.explorerRecommendedWalletIds) === 'NONE'
                    ? undefined
                    : (_d = config.web3ModalConfig) === null || _d === void 0 ? void 0 : _d.explorerRecommendedWalletIds);
        config.privacyPolicyUrl = config.privacyPolicyUrl || ((_e = config.web3ModalConfig) === null || _e === void 0 ? void 0 : _e.privacyPolicyUrl);
        Reflect.deleteProperty(config, 'web3ModalConfig');
        this._connecting = false;
        this._wallet = null;
        this._address = null;
        this._config = config;
    }
    get address() {
        return this._address;
    }
    get readyState() {
        return this._readyState;
    }
    get state() {
        return this._state;
    }
    /**
     * Currently unused for WalletConnectAdapter.
     */
    get connecting() {
        return this._connecting;
    }
    connect() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                if (this.connected)
                    return;
                if (this.state === AdapterState.NotFound)
                    throw new WalletNotFoundError();
                this._connecting = true;
                let address = '';
                try {
                    if (!this._wallet) {
                        this._wallet = new WalletConnectWallet(Object.assign(Object.assign({}, this._config), { network: WalletConnectChainID[this._config.network] ||
                                `tron:${this._config.network}` }));
                    }
                    ({ address } = yield this._wallet.connect());
                }
                catch (error) {
                    if (error.message === 'User closed the connection modal')
                        throw new WalletWindowClosedError();
                    throw new WalletConnectionError(error === null || error === void 0 ? void 0 : error.message, error);
                }
                this._wallet.on('disconnect', this._disconnected);
                this._wallet.on('accountsChanged', this._accountsChanged);
                this._address = address || '';
                this._state = AdapterState.Connected;
                this.emit('stateChanged', this._state);
                this.emit('connect', address);
            }
            catch (error) {
                this.emit('error', error);
                throw error;
            }
            finally {
                // this._connecting = false;
            }
        });
    }
    disconnect() {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.state === AdapterState.NotFound || !this.connected) {
                return;
            }
            const wallet = this._wallet;
            if (wallet) {
                wallet.off('disconnect', this._disconnected);
                wallet.off('accountsChanged', this._accountsChanged);
                this._address = null;
                try {
                    yield wallet.disconnect();
                }
                catch (error) {
                    this.emit('error', new WalletDisconnectionError(error === null || error === void 0 ? void 0 : error.message, error));
                }
            }
            this._state = AdapterState.Disconnect;
            this.emit('disconnect');
            this.emit('stateChanged', this._state);
        });
    }
    signTransaction(transaction) {
        return __awaiter(this, void 0, void 0, function* () {
            if (this.state !== AdapterState.Connected)
                throw new WalletDisconnectedError();
            try {
                const wallet = this._wallet;
                if (!wallet)
                    throw new WalletDisconnectedError();
                try {
                    return yield wallet.signTransaction(transaction);
                }
                catch (error) {
                    throw new WalletSignTransactionError(error === null || error === void 0 ? void 0 : error.message, error);
                }
            }
            catch (error) {
                this.emit('error', error);
                throw error;
            }
        });
    }
    signMessage(message) {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                const wallet = this._wallet;
                if (!wallet)
                    throw new WalletDisconnectedError();
                try {
                    return yield wallet.signMessage(message);
                }
                catch (error) {
                    throw new WalletSignMessageError(error === null || error === void 0 ? void 0 : error.message, error);
                }
            }
            catch (error) {
                this.emit('error', error);
                throw error;
            }
        });
    }
    /**
     * Get WalletConnect connection status.
     * Address is not empty if the WalletConnectWallet is connected.
     * @returns {object} status
     * @property {string} status.address - connected address
     */
    getConnectionStatus() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this._wallet || !this.connected) {
                return { address: '' };
            }
            try {
                return yield this._wallet.checkConnectStatus();
            }
            catch (e) {
                this._address = null;
                this._state = AdapterState.Disconnect;
                return { address: '' };
            }
        });
    }
}
//# sourceMappingURL=adapter.js.map